name: unified-search-app
pool:
  vmImage: ubuntu-latest

trigger:
  batch: true
  branches:
    include:
      - main
  path:
    include:
      - unified-search-app
    

stages:
  - stage: Compliance
    dependsOn: []
    jobs:
      - job: compliance
        displayName: Compliance
        pool:
          vmImage: windows-latest
        steps:
          - task: CredScan@3
            inputs:
              outputFormat: sarif
              debugMode: false

          - task: ComponentGovernanceComponentDetection@0
            inputs:
              scanType: "Register"
              verbosity: "Verbose"
              alertWarningLevel: "High"

          - task: PublishSecurityAnalysisLogs@3
            inputs:
              ArtifactName: "CodeAnalysisLogs"
              ArtifactType: "Container"

  - stage: Build_deploy
    dependsOn: []
    jobs:
      - job: build
        displayName: Build and deploy
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: "3.11"
            displayName: "Use Python 3.11"

          - task: Docker@2
            inputs:
              containerRegistry: '$(containerRegistry)'
              repository: 'main'
              command: 'buildAndPush'
              Dockerfile: 'Dockerfile'
              tags: 'latest'
          - task: AzureAppServiceManage@0
            inputs:
              azureSubscription: '$(subscription)'
              Action: 'Restart Azure App Service'
              WebAppName: '$(webApp)'